void ICACHE_FLASH_ATTR otaCheckAvailableCb(char * response, int http_status, char * full_response){  uint8_t tx_buf[128]={0};  if (http_status==HTTP_STATUS_GENERIC_ERROR) {    os_sprintf(tx_buf, "Could not connect to OTA update server.\r\n");  } else if (http_status==200) {    uint8_t available_version = atoi(response);    if (available_version>FIRMWARE_VERSION) {      os_sprintf(tx_buf, "New firmware version (%d) available!\r\n", available_version);    } else if (available_version<FIRMWARE_VERSION) {      os_sprintf(tx_buf, "No new firmware available, ota server supplies old version %d.\r\n", available_version);    } else {      os_sprintf(tx_buf, "Firmware is up-to-date!\r\n");    }    //os_printf("strlen(full_response)=%d\n", strlen(full_response));    //os_printf("response=%s<EOF>\n", response);  } else {    os_sprintf(tx_buf, "OTA service unavailable (%d)\r\n", http_status);  }  tx_buff_enq(tx_buf, os_strlen(tx_buf));}uint32_t otaSector;uint32_t otaWriteTo;uint32_t otaAvailableVersion;uint32_t otaSize;void ICACHE_FLASH_ATTR otaDoUpdateStep3Cb(char * response, int http_status, char * full_response){  uint8_t tx_buf[128]={0};  if (http_status==200) {    unsigned char sectordata[SPI_FLASH_SEC_SIZE];    uint32_t io = base64_decode(strlen(response), response, SPI_FLASH_SEC_SIZE, sectordata); //Might need to be changed to &sensordata    uint32_t max = SPI_FLASH_SEC_SIZE;    if ((io==max)||(io<max)) {      uint32_t sector = otaWriteTo+otaSector;      uint32_t sector_address = sector*SPI_FLASH_SEC_SIZE;      os_sprintf(tx_buf, "Writing to sector 0x%x...\r\n", sector);      spi_flash_erase_sector(sector);      spi_flash_write(sector_address, (uint32 *) sectordata, io);      otaSector++;      if (otaSector*SPI_FLASH_SEC_SIZE>=otaSize) {        os_sprintf(tx_buf, "OTA update completed. Restarting...\r\n");        uint8_t rom = 0;        if (rboot_get_current_rom()==0) rom = 1;        rboot_set_current_rom(rom);        tx_buff_enq(tx_buf, os_strlen(tx_buf));        //os_delay_us(2000000); //Wait 2 seconds.	system_restart();	while(1); //Halt.      } else {        char url[128];        os_sprintf(url, "http://%s?device=%d&version=%d&get=%d&sector=%d", UPDATE_SVR, DEVICE_TYPE, FIRMWARE_VERSION, otaAvailableVersion, otaSector);        http_get( url, "", otaDoUpdateStep3Cb );      }    } else {      os_sprintf(tx_buf, "Error at sector #%d: too much data (%d)!\r\n", otaSector, io);    }  } else {    os_sprintf(tx_buf, "OTA service unavailable (%d)\r\n", http_status);  }  tx_buff_enq(tx_buf, os_strlen(tx_buf));}void ICACHE_FLASH_ATTR otaDoUpdateStep2Cb(char * response, int http_status, char * full_response){  uint8_t tx_buf[128]={0};  if (http_status==200) {    otaSize = atoi(response);    os_sprintf(tx_buf, "Update size: %d bytes.\r\n", otaSize);    if ((otaSize>0) && (otaSize<FLASH_FIRMWARE_SECTORS*SPI_FLASH_SEC_SIZE)) {      uint8_t rom = 0;      otaSector = 0;      otaWriteTo = FLASH_USER1_SECTOR;      if (rboot_get_current_rom()==0) {        rom = 1;        otaWriteTo = FLASH_USER2_SECTOR;      }      char url[128];      os_sprintf(url, "http://%s?device=%d&version=%d&rom=%d&get=%d&sector=%d", UPDATE_SVR, DEVICE_TYPE, FIRMWARE_VERSION, rom, otaAvailableVersion, otaSector);      http_get( url, "", otaDoUpdateStep3Cb );    } else {      os_sprintf(tx_buf, "OTA error: invalid size.\r\n");    }  } else {    os_sprintf(tx_buf, "OTA service unavailable (%d)\r\n", http_status);  }  tx_buff_enq(tx_buf, os_strlen(tx_buf));}void ICACHE_FLASH_ATTR otaDoUpdateStep1Cb(char * response, int http_status, char * full_response){  uint8_t tx_buf[128]={0};  if (http_status==HTTP_STATUS_GENERIC_ERROR) {    os_sprintf(tx_buf, "Could not connect to OTA update server.\r\n");  } else if (http_status==200) {    otaAvailableVersion = atoi(response);    if (otaAvailableVersion>FIRMWARE_VERSION) {      os_sprintf(tx_buf, "Updating to version %d.\r\n", otaAvailableVersion);      char url[128];      os_sprintf(url, "http://%s?device=%d&version=%d&get=%d&size", UPDATE_SVR, DEVICE_TYPE, FIRMWARE_VERSION, otaAvailableVersion);      http_get( url, "", otaDoUpdateStep2Cb );    } else {      os_sprintf(tx_buf, "No update available, update canceled!\r\n");    }    //os_printf("strlen(full_response)=%d\n", strlen(full_response));    //os_printf("response=%s<EOF>\n", response);  } else {    os_sprintf(tx_buf, "OTA service unavailable (%d)\r\n", http_status);  }  tx_buff_enq(tx_buf, os_strlen(tx_buf));}#ifdef UART_MENUos_timer_t uartTimer;static void ICACHE_FLASH_ATTR uartTimerCb(void *arg){  uint8_t uart_buf[128]={0};  uint16_t len = 0;  len = rx_buff_deq(uart_buf, 128 );  if (len>0) {    //tx_buff_enq(uart_buf,len);    int i;    uint8_t tx_buf[128]={0};    for (i = 0; i < len; i++) {      if (uart_buf[i]=='?') {        os_sprintf(tx_buf, "Menu:\r\n?. Help\ns. heap info (debug)\r\nv. Firmware version\r\no. OTA update\r\nc. check for new firmware\r\n"); //t. udp test\r\n      } else if (uart_buf[i]=='s') {        system_print_meminfo();      } else if (uart_buf[i]=='v') {        os_sprintf(tx_buf, "Device type: %d\r\nFirmware version: %d\r\nRunning app: %d\r\n", DEVICE_TYPE, FIRMWARE_VERSION, rboot_get_current_rom());      } else if (uart_buf[i]=='c') {        char url[128];        os_sprintf(url, "http://%s?device=%d&version=%d&info=1", UPDATE_SVR, DEVICE_TYPE, FIRMWARE_VERSION);        http_get( url, "", otaCheckAvailableCb );        os_sprintf(tx_buf, "Checking for available updates... (%s)\r\n",url);      } else if (uart_buf[i]=='o') {        char url[128];        os_sprintf(url, "http://%s?device=%d&version=%d&info=1", UPDATE_SVR, DEVICE_TYPE, FIRMWARE_VERSION);        http_get( url, "", otaDoUpdateStep1Cb );        os_sprintf(tx_buf, "OTA update started!\r\n",url);      /*} else if (uart_buf[i]=='t') {        uint8_t server[4] = {192, 168, 0, 117};        int port = 1337;        char data[64];        os_sprintf(data, "Hello world!");        uint16 length = os_strlen( data );        os_sprintf(tx_buf, "UDP test result: %d.\r\n", send_udp((uint8_t*) &server, port, (char*) &data, length));      } else if (uart_buf[i]=='h') {        os_sprintf(tx_buf, "Running http client test...\r\n");        httpClientConnect(); */      } else {        os_sprintf(tx_buf, "Unknown command (%c).\r\n", uart_buf[i]);      }      uint8_t tx_buf_len = os_strlen(tx_buf);      if (tx_buf_len>0) {        tx_buff_enq(tx_buf,tx_buf_len);      }    }  }}#endif